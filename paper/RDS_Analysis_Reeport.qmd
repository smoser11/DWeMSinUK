---
title: "Modern Slavery Among Domestic Workers: Comprehensive RDS Analysis"
author: "Research Team"
date: "`r Sys.Date()`"
format:
  html:
    code-fold: true
    toc: true
    toc-depth: 3
    theme: cosmo
    fig-width: 10
    fig-height: 6
  pdf:
    toc: true
    number-sections: true
    fig-width: 8
    fig-height: 5
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(tidyverse)
library(kableExtra)
library(ggplot2)
library(plotly)
library(DT)
library(gt)

# Load results
load("output/rds_estimates.RData")
load("data/processed/prepared_data.RData")
```

## Executive Summary

This analysis estimates the prevalence of modern slavery among domestic workers in the UK using multiple RDS methodologies. We examine two primary indicators across various population size assumptions and estimation techniques.

**Key Findings:**
- Below minimum wage prevalence (Q36): X.X% - Y.Y% (95% CI)
- NRM referral experience (Q80): A.A% - B.B% (95% CI)  
- Population size estimates: 980,000 - 1.74M domestic workers

## Sample Characteristics

### Recruitment Network Structure

```{r network-summary}
#| label: tbl-network
#| tbl-cap: "RDS Sample Network Characteristics"

network_stats <- tibble(
  Characteristic = c("Total Sample Size", "Recruitment Waves", "Average Degree", 
                    "Median Degree", "Seeds", "Longest Chain", "Mean Chain Length"),
  Value = c(
    nrow(rd.dd),
    max(rd.dd$wave, na.rm = TRUE),
    round(mean(rd.dd$numRef, na.rm = TRUE), 1),
    round(median(rd.dd$numRef, na.rm = TRUE), 1),
    sum(rd.dd$recruiter.id == -1),
    "TBD", # Calculate from recruitment chains
    "TBD"  # Calculate average chain length
  )
)

network_stats %>%
  gt() %>%
  tab_header(title = "Network Characteristics") %>%
  fmt_number(columns = Value, decimals = 1, use_seps = TRUE)
```

### Demographic Composition

```{r demographics}
#| label: fig-demographics
#| fig-cap: "Sample Composition by Nationality Clusters"

# Create nationality breakdown
nationality_summary <- rd.dd %>%
  group_by(nationality_cluster) %>%
  summarise(
    n = n(),
    percent = round(n() / nrow(rd.dd) * 100, 1),
    .groups = 'drop'
  )

ggplot(nationality_summary, aes(x = nationality_cluster, y = percent, fill = nationality_cluster)) +
  geom_col() +
  geom_text(aes(label = paste0(n, "\n(", percent, "%)")), vjust = -0.5) +
  scale_fill_viridis_d() +
  theme_minimal() +
  labs(x = "Nationality Cluster", y = "Percentage", 
       title = "Sample Distribution by Nationality") +
  theme(legend.position = "none")
```

## RDS Estimation Results

### Model-Assisted Estimates by Population Size

```{r ma-estimates-table}
#| label: tbl-ma-estimates
#| tbl-cap: "Model-Assisted Estimates by Population Size and Seed Selection"

# Extract MA results and create comparison table
ma_comparison <- expand_grid(
  seed_method = c("sample", "random", "degree"),
  pop_size = c(100000, 953000, 1000000, 1500000),
  indicator = c("q36", "q80", "composite_risk")
) %>%
  rowwise() %>%
  mutate(
    key = paste0(seed_method, "_", pop_size),
    estimate = ifelse(key %in% names(ma_results),
                     ma_results[[key]][[indicator]]$estimate, NA),
    ci_lower = ifelse(key %in% names(ma_results),
                     ma_results[[key]][[indicator]]$conf.int[1], NA),
    ci_upper = ifelse(key %in% names(ma_results),
                     ma_results[[key]][[indicator]]$conf.int[2], NA)
  ) %>%
  ungroup() %>%
  filter(!is.na(estimate))

# Create formatted table
ma_comparison %>%
  mutate(
    pop_size_f = scales::comma(pop_size),
    estimate_ci = sprintf("%.3f (%.3f, %.3f)", estimate, ci_lower, ci_upper)
  ) %>%
  select(seed_method, pop_size_f, indicator, estimate_ci) %>%
  pivot_wider(names_from = indicator, values_from = estimate_ci) %>%
  gt() %>%
  tab_header(title = "Model-Assisted Estimates by Method") %>%
  cols_label(
    seed_method = "Seed Selection",
    pop_size_f = "Population Size",
    q36 = "Below Min Wage",
    q80 = "NRM Experience", 
    composite_risk = "Composite Risk"
  ) %>%
  tab_spanner(label = "Prevalence Estimates (95% CI)", columns = c(q36, q80, composite_risk))
```

### Traditional RDS Estimators Comparison

```{r rds-comparison}
#| label: tbl-rds-comparison
#| tbl-cap: "RDS Estimator Comparison (N=980,000)"

# Extract RDS estimates for standard population size
rds_980k <- rds_results[["980000"]]

rds_table <- tibble(
  Method = c("RDS-I", "RDS-II", "Successive Sampling"),
  `Q36 Estimate` = c(
    rds_980k$rds_i$q36$estimate,
    rds_980k$rds_ii$q36$estimate,
    rds_980k$rds_ss$q36$estimate
  ),
  `Q36 95% CI` = c(
    sprintf("(%.3f, %.3f)", rds_980k$rds_i$q36$conf.int[1], rds_980k$rds_i$q36$conf.int[2]),
    sprintf("(%.3f, %.3f)", rds_980k$rds_ii$q36$conf.int[1], rds_980k$rds_ii$q36$conf.int[2]),
    sprintf("(%.3f, %.3f)", rds_980k$rds_ss$q36$conf.int[1], rds_980k$rds_ss$q36$conf.int[2])
  ),
  `Q80 Estimate` = c(
    rds_980k$rds_i$q80$estimate,
    rds_980k$rds_ii$q80$estimate,
    rds_980k$rds_ss$q80$estimate
  ),
  `Q80 95% CI` = c(
    sprintf("(%.3f, %.3f)", rds_980k$rds_i$q80$conf.int[1], rds_980k$rds_i$q80$conf.int[2]),
    sprintf("(%.3f, %.3f)", rds_980k$rds_ii$q80$conf.int[1], rds_980k$rds_ii$q80$conf.int[2]),
    sprintf("(%.3f, %.3f)", rds_980k$rds_ss$q80$conf.int[1], rds_980k$rds_ss$q80$conf.int[2])
  )
)

rds_table %>%
  gt() %>%
  tab_header(title = "Traditional RDS Estimators") %>%
  tab_spanner(label = "Below Minimum Wage (Q36)", columns = c("Q36 Estimate", "Q36 95% CI")) %>%
  tab_spanner(label = "NRM Experience (Q80)", columns = c("Q80 Estimate", "Q80 95% CI")) %>%
  fmt_number(columns = c("Q36 Estimate", "Q80 Estimate"), decimals = 3)
```

### Population Size Sensitivity Analysis

```{r sensitivity-plot}
#| label: fig-sensitivity
#| fig-cap: "Estimate Sensitivity to Population Size Assumptions"

# Create sensitivity plot
sensitivity_data <- map_dfr(names(rds_results), function(pop_size) {
  results <- rds_results[[pop_size]]
  tibble(
    pop_size = as.numeric(pop_size),
    rds_i_q36 = results$rds_i$q36$estimate,
    rds_ii_q36 = results$rds_ii$q36$estimate,
    rds_ss_q36 = results$rds_ss$q36$estimate,
    rds_i_q80 = results$rds_i$q80$estimate,
    rds_ii_q80 = results$rds_ii$q80$estimate,
    rds_ss_q80 = results$rds_ss$q80$estimate
  )
}) %>%
  pivot_longer(cols = -pop_size, names_to = "method_indicator", values_to = "estimate") %>%
  separate(method_indicator, into = c("method", "indicator"), sep = "_(?=[^_]+$)") %>%
  mutate(
    method = case_when(
      str_detect(method, "rds_i") ~ "RDS-I",
      str_detect(method, "rds_ii") ~ "RDS-II", 
      str_detect(method, "rds_ss") ~ "RDS-SS"
    ),
    indicator = case_when(
      indicator == "q36" ~ "Below Min Wage",
      indicator == "q80" ~ "NRM Experience"
    )
  )

ggplot(sensitivity_data, aes(x = pop_size, y = estimate, color = method, linetype = indicator)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_x_continuous(labels = scales::comma, breaks = unique(sensitivity_data$pop_size)) +
  scale_y_continuous(labels = scales::percent) +
  scale_color_viridis_d() +
  theme_minimal() +
  labs(x = "Assumed Population Size", y = "Prevalence Estimate",
       color = "Method", linetype = "Indicator",
       title = "Sensitivity to Population Size Assumptions") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Bayesian Analysis

### Population Size Estimation

```{r ss-pse-results}
#| label: tbl-sspse
#| tbl-cap: "Successive Sampling Population Size Estimates"

ss_summary <- summary(ss_pse, HPD.level = 0.95)

tibble(
  Parameter = "Population Size",
  Mean = ss_summary$statistics["Mean"],
  SD = ss_summary$statistics["SD"],
  `2.5%` = ss_summary$quantiles["2.5%"],
  `50%` = ss_summary$quantiles["50%"],
  `97.5%` = ss_summary$quantiles["97.5%"]
) %>%
  gt() %>%
  tab_header(title = "Bayesian Population Size Estimates") %>%
  fmt_number(columns = everything()[-1], decimals = 0, use_seps = TRUE)
```

### Composite Risk Distribution

```{r risk-distribution}
#| label: fig-risk-dist
#| fig-cap: "Distribution of Composite Risk Scores"

ggplot(rd.dd, aes(x = composite_risk)) +
  geom_histogram(bins = 30, fill = "steelblue", alpha = 0.7, color = "white") +
  geom_density(aes(y = ..density.. * nrow(rd.dd) * 0.1), color = "red", size = 1) +
  theme_minimal() +
  labs(x = "Composite Risk Score", y = "Frequency",
       title = "Distribution of Modern Slavery Risk Scores",
       subtitle = "Histogram with kernel density overlay")
```

## Model Diagnostics

### Convergence Assessment

```{r convergence}
#| label: fig-convergence
#| fig-cap: "RDS Convergence Diagnostics"

# Create convergence plots
conv_q36 <- convergence.plot(rd.dd, "zQ36")
conv_q80 <- convergence.plot(rd.dd, "zQ80")

gridExtra::grid.arrange(conv_q36, conv_q80, ncol = 2)
```

### Sample Composition by Wave

```{r wave-composition}
#| label: tbl-wave-composition
#| tbl-cap: "Sample Composition by Recruitment Wave"

wave_summary <- rd.dd %>%
  group_by(wave) %>%
  summarise(
    n = n(),
    pct_q36 = mean(zQ36, na.rm = TRUE) * 100,
    pct_q80 = mean(zQ80, na.rm = TRUE) * 100,
    mean_risk = mean(composite_risk, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(cumulative_n = cumsum(n))

wave_summary %>%
  gt() %>%
  tab_header(title = "Recruitment Wave Analysis") %>%
  cols_label(
    wave = "Wave",
    n = "N",
    cumulative_n = "Cumulative N",
    pct_q36 = "% Below Min Wage",
    pct_q80 = "% NRM Experience",
    mean_risk = "Mean Risk Score"
  ) %>%
  fmt_number(columns = c(pct_q36, pct_q80, mean_risk), decimals = 1) %>%
  fmt_number(columns = c(n, cumulative_n), decimals = 0, use_seps = TRUE)
```

## Discussion

### Key Findings

1. **Prevalence Estimates**: Modern slavery indicators show substantial prevalence among domestic workers, with below minimum wage employment affecting approximately X% of the population and Y% having NRM experience.

2. **Method Comparison**: Model-assisted estimates show [pattern], while traditional RDS estimators demonstrate [comparison]. The choice of seed selection method appears to [impact/not impact] results significantly.

3. **Population Size Sensitivity**: Estimates show [stability/variation] across different assumed population sizes, suggesting [interpretation].

### Methodological Considerations

1. **Network Structure**: The recruitment network demonstrates [characteristics], which [supports/challenges] RDS assumptions.

2. **Convergence**: Diagnostic plots indicate [convergence status] after [number] waves.

3. **Sample Composition**: Wave-by-wave analysis reveals [patterns] in recruitment effectiveness and sample composition.

### Limitations

1. **Sampling Limitations**: 
   - Potential recruitment bias
   - Network boundary effects
   - Seed selection effects

2. **Measurement Issues**:
   - Self-reported network sizes
   - Sensitive topic reporting bias
   - Missing data patterns

### Policy Implications

The findings suggest that modern slavery among domestic workers is [characterization] with implications for:

1. **Policy Development**: [Recommendations]
2. **Service Provision**: [Recommendations]  
3. **Future Research**: [Recommendations]

## References

[Bibliography would be automatically generated from citations]

## Appendix

### Technical Details

- Sample size: `r nrow(rd.dd)`
- Recruitment period: [Period]
- Geographic coverage: [Areas]
- Languages: [Languages used]

### Code Availability

Analysis code is available at [GitHub repository] under [license].